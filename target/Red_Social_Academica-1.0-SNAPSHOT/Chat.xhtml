<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <title>Chat</title>
        <script type="text/javascript">
            var ws;
            var reconnectInterval = 5000; // 5 seconds
            var maxReconnectAttempts = 10;
            var reconnectAttempts = 0;

            function connect() {
                ws = new WebSocket("ws://localhost:8080/Red_Social_Academica/websocket/chat");

               ws.onmessage = function (event) {
            const message = event.data;
            console.log("Received message: " + message); // Debugging log
            if (message.startsWith("COMMAND:")) {
                const command = message.split(":")[1];
                console.log("Received command: " + command); // Debugging log
                if (command === "CLEAR_CHAT") {
                    clearChat();
                }
            } else {
                const messageList = document.getElementById('messages');
                const messageItem = document.createElement('li');
                messageItem.textContent = message;
                messageList.appendChild(messageItem);
                scrollToBottom();
            }
        };

                ws.onopen = function () {
                    console.log('Connected to chat');

                };

                ws.onclose = function (event) {
                    console.log('Disconnected from chat', event);

                };

                ws.onerror = function (error) {
                    console.error('WebSocket error: ', error);
                    ws.close();
                };
            }

            function sendMessage() {
                if (ws.readyState === WebSocket.OPEN) {
                    const messageInput = document.getElementById('message');
                    const message = messageInput ? messageInput.value : '';
                    if (message.trim() !== '') {
                        ws.send(message);
                        messageInput.value = '';
                    } else {
                        console.error('Message is empty');
                    }
                } else {
                    console.error('WebSocket is not open or not initialized');
                }
            }
            
            function clearChat() {
                const messageList = document.getElementById('messages');
                while (messageList.firstChild) {
                    messageList.removeChild(messageList.firstChild);
                }
            }

            function scrollToBottom() {
                const messages = document.getElementById('messages');
                if (messages.lastElementChild) {
                    messages.lastElementChild.scrollIntoView();
                }
            }


            window.onload = connect;
        </script>
    </h:head>
    <h:body>
        <h:form id="chatForm">
            <p:panel header="Chat">
                <p:outputPanel id="chatPanel" style="border: 1px solid #ccc; height: 300px; overflow-y: auto;">
                    <!-- List to display messages -->
                    <ul id="messages" style="list-style-type: none; padding: 0; margin: 0;">
                    </ul>
                </p:outputPanel>
                <input type="text" id="message" placeholder="Type your message here" />
                <button type="button" onclick="sendMessage()">Send</button>
            </p:panel>
        </h:form>
    </h:body>
</html>